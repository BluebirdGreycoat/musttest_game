-- "For no one, no one in Enyekala you can trust. Not men, not women, not code... unless it's properly formatted."local function a()minetest.log("action","What is best in life? Proper line endings, obviously!")end;sw={}sw.modpath=minetest.get_modpath("sw")sw.worldpath=minetest.get_worldpath()dofile(sw.modpath.."/noise.lua")dofile(sw.modpath.."/data.lua")dofile(sw.modpath.."/tunnel.lua")dofile(sw.modpath.."/despeckle.lua")dofile(sw.modpath.."/spheres.lua")dofile(sw.modpath.."/biome.lua")dofile(sw.modpath.."/caverns.lua")dofile(sw.modpath.."/xen.lua")local b=10150;local c=15150;local d=10150+200;local e=b+12;local f=10170;local g=math.tan(1)local h=c-2000;local i=c;local j=math.random;local k=math.abs;local l=math.floor;local m=math.max;local n=math.min;local o=math.sin;local p=math.cos;local q=math.tan;local r=vector.distance;local function s(t,u,v)return m(u,n(t,v))end;local w=minetest.get_content_id("air")local x=minetest.get_content_id("ignore")local y=minetest.get_content_id("default:stone")local z=minetest.get_content_id("default:cobble")local A=minetest.get_content_id("bedrock:bedrock")local B=minetest.get_content_id("lbrim:lava_source")local C={}local D={}local E={}sw.generate_realm=function(F,G,H,I)I=mapgen.get_blockseed(G)if G.y>c or H.y<b then return end;a()local J=os.clock()local K={}K.minp=G;K.maxp=H;K.need_mapfix=true;K.on_construct={}K.cavern_hints={}local L,M=F:get_emerged_area()F:set_lighting({day=0,night=0})F:get_data(C)F:get_light_data(D)F:get_param2_data(E)local N=VoxelArea:new({MinEdge=L,MaxEdge=M})local O=VoxelArea2D:new({MinEdge={x=L.x,y=L.z},MaxEdge={x=M.x,y=M.z}})local P=PseudoRandom(I+672)local Q=H.x;local R=H.y;local S=H.z;local T=G.x;local U=G.y;local V=G.z;local W=M.x-L.x+1;local X=M.y-L.y+1;local Y=M.z-L.z+1;local Z={x=W,y=Y}local _={x=W,y=X,z=Y}local a0={x=L.x,y=L.z}local a1={x=L.x,y=L.y,z=L.z}local a2,a3=sw.get_2d_noise(a0,Z,"baseterrain")local a4,a5=sw.get_2d_noise(a0,Z,"continental")local a6,a7=sw.get_2d_noise(a0,Z,"mountains")local a8,a9=sw.get_2d_noise(a0,Z,"mtnchannel")local aa=sw.get_2d_noise(a0,Z,"rough_terrain")local ab=sw.get_3d_noise(a1,_,"cavern_noise5")local ac,ad=sw.get_3d_noise(a1,_,"shear1")local ae,af=sw.get_3d_noise(a1,_,"shear2")local ag,ah=sw.get_3d_noise(a1,_,"softener")local function ai(aj,ak,al)local am=N:index(aj,ak,al)local an=l(aj+ac[am]*n(1,k(ag[am])))local ao=l(al+ae[am]*n(1,k(ag[am])))an=s(an,L.x,M.x)ao=s(ao,L.z,M.z)local ap=O:index(an,ao)local aq=O:index(aj,al)local ar=q(n(1,k(a8[ap])))/g;ar=ar*ar*ar;local as=d+l(a2[ap]+a4[ap]+a6[ap]*ar)local at=k(ab[N:index(an,ak,ao)])if at>aa[aq]then as=as+5 end;return l(as)end;local function au(aj,al)local av={x=aj,y=al}local ar=q(n(1,k(a9:get_2d(av))))/g;ar=ar*ar*ar;local as=d+l(a3:get_2d(av)+a5:get_2d(av)+a7:get_2d(av)*ar)return as end;local aw={au(T,V),au(Q,V),au(Q,S),au(T,S),au(l((T+Q)/2),l((V+S)/2)),au(l((T+Q)/2),V),au(Q,l((V+S)/2)),au(l((T+Q)/2),S),au(T,l((V+S)/2))}local function ax(ay)for az,aA in ipairs(aw)do local aB=aA+ay;if ay<0 and R>=aB then return false end;if ay>0 and U<=aB then return false end end;return true end;if ax(-250)then for al=V,S do for aj=T,Q do local aC=P:next(0,3)for ak=U,R do if ak>=b and ak<=c then local aD=N:index(aj,ak,al)local aE=C[aD]if aE==w or aE==x then if ak<=e+aC then C[aD]=A else C[aD]=y end end end end end end;for al=L.z,M.z do for ak=L.y,M.y do if ak>=b and ak<=c then for aj=L.x,M.x do local aD=N:index(aj,ak,al)D[aD]=0 end end end end elseif ax(250)then for al=L.z,M.z do for ak=L.y,M.y do if ak>=b and ak<=c then for aj=L.x,M.x do local aD=N:index(aj,ak,al)D[aD]=15 end end end end else for al=V,S do for aj=T,Q do local aC=P:next(0,3)for ak=U,R do local as=ai(aj,ak,al)if ak>=b and ak<=c then local aD=N:index(aj,ak,al)local aE=C[aD]if aE==w or aE==x then if ak<=e+aC then C[aD]=A elseif ak<=as then C[aD]=y else C[aD]=w end end end end end end;for al=L.z,M.z do for ak=L.y,M.y do if ak>=b and ak<=c then for aj=L.x,M.x do local as=ai(aj,ak,al)local aD=N:index(aj,ak,al)if ak<=as then D[aD]=0 else D[aD]=15 end end end end end end;F:set_data(C)F:set_light_data(D)F:set_param2_data(E)local aF=sw.generate_xen(F,G,H,I,ac,ae,K)if ax(-100)then sw.generate_caverns(F,G,H,I,au)end;if not ax(250)or R>=h and aF then sw.generate_tunnels(F,G,H,I,au)end;if not ax(-250)and not ax(250)then sw.generate_spheres(F,G,H,I,b,c,au)end;if U<=h or aF then sw.despeckle_terrain(F,G,H)end;if not ax(-250)and not ax(250)then sw.generate_biome(F,G,H,I,b,c,ai,au,K)end;if aF then sw.generate_xen_biome(F,G,H,I)end;if U<=h or aF then minetest.generate_ores(F)minetest.generate_decorations(F)end;F:calc_lighting(vector.offset(L,0,16,0),vector.offset(M,0,-16,0),true)if ax(-100)or ax(250)and U<h+550 then K.need_mapfix=false end;minetest.save_gen_notify("sw:mapgen_info",K)local aG=os.clock()end;minetest.register_on_generated(function(...)sw.generate_realm(...)end)
